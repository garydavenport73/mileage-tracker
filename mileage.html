<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mileage Tracker</title>
    <style>
        * {
            box-sizing: border-box;
        }
        
        html {
            background-color: lightskyblue;
        }
        
        main {
            width: 320px;
            margin: auto;
            background-color: lightblue;
            border-radius: 5px;
        }
        /* TOP OF MAIN/NAV */
        
        h1,
        nav {
            background-color: lightskyblue;
            width: 80%;
            text-align: center;
            border-radius: 5px;
        }
        /* 'FORM' ELEMENTS */
        
        button,
        input {
            padding: 2px;
            margin: 2px;
            border-radius: 5px;
            border: 1px solid grey;
            height: 30px;
        }
        
        button:hover {
            background-color: lightblue;
        }
        
        input {
            width: 80%;
        }
        
        button {
            min-width: 40px;
        }
        /* TABLLE STYLES */
        
        table {
            background-color: lightskyblue;
            border-radius: 5px;
            border: 2px solid whitesmoke;
        }
        
        tr {
            background-color: lightblue;
        }
        
        th {
            background-color: lightskyblue;
        }
        
        td {
            max-width: 50px;
            overflow-wrap: break-word;
        }
        
        tr:hover {
            background-color: lightskyblue;
            background-color: white;
        }
        /* DEFAULT FLOW */
        
        .flex-column {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
    </style>

</head>

<body>

    <main id="main-table" class="flex-column">
        <h1>Mileage Tracker</h1>
        <nav><button onclick="load()">Load</button><button onclick="save()">Save</button><button onclick="newEntry()">New</button></nav>
        <label for="start-date">Start Date: </label><input type="date" id="start-date" onchange="populateTable()">
        <label for="end-date">End Date: </label><input type="date" id="end-date" onchange="populateTable()">
        <table id="mileage-table">
            <tr>
                <th></th>
                <th>Date</th>
                <th>Start</th>
                <th>End</th>
                <th>Total</th>
                <th>Dest</th>
                <th>Purpose</th>
            </tr>
            <tr>
                <th></th>
                <th></th>
                <th></th>
                <th>Total:</th>
                <th>0</th>
                <th></th>
                <th></th>
            </tr>
        </table>
        <hr>
    </main>

    <main id="main-entry" class="flex-column">
        <h1>Mileage Tracker</h1>
        <h3>Entry
            <span id="table-row-index">1</span> Date: 01-01.2000</h3>
        <nav><button onclick="saveEntry()">Save</button><button onclick="cancelEdit()">Cancel</button><button onclick="deleteEntry()">Delete</button></nav>
        <label for="entry-date">Date: </label><input type="date" id="entry-date">
        <label for="start">Start: </label><input type="number" id="start">
        <label for="end">End:</label><input type="number" id="end">
        <label for="destination">Destination:</label><input type="text" id="destination">
        <label for="purpose">Purpose:</label><input type="text" id="purpose">
        <hr>
    </main>

    <script>
        let tableMain = document.getElementById("main-table");
        let entryMain = document.getElementById("main-entry");
        let entries = [];

        function newEntry() {
            tableMain.style.display = "none";
            entryMain.style.display = "flex";
            let row = {};
            row["date"] = getTodaysDate();
            row["start"] = 0;
            row["end"] = 0;
            row["destination"] = "";
            row["purpose"] = "";
            entries.push(row);
            let tableRowIndex = entries.length;
            document.getElementById("entry-date").value = row["date"];
            document.getElementById("start").value = row["start"];
            document.getElementById("end").value = row["end"];
            document.getElementById("destination").value = row["destination"];
            document.getElementById("purpose").value = row["purpose"];
            document.getElementById("table-row-index").innerText = tableRowIndex.toString();
            console.log(entries);
        }

        function editEntry(entriesIndex) {
            tableMain.style.display = "none";
            entryMain.style.display = "flex";
            let tableRowIndex = entriesIndex + 1;
            document.getElementById("table-row-index").innerText = tableRowIndex.toString();
            document.getElementById("entry-date").value = entries[entriesIndex]["date"];
            document.getElementById("start").value = entries[entriesIndex]["start"];
            document.getElementById("end").value = entries[entriesIndex]["end"];
            document.getElementById("destination").value = entries[entriesIndex]["destination"];
            document.getElementById("purpose").value = entries[entriesIndex]["purpose"];
        }

        function saveEntry() {
            let tableRowIndex = parseInt(document.getElementById("table-row-index").innerText);
            let entriesIndex = tableRowIndex - 1;
            entries[entriesIndex]["date"] = document.getElementById("entry-date").value;
            entries[entriesIndex]["start"] = document.getElementById("start").value;
            entries[entriesIndex]["end"] = document.getElementById("end").value;
            entries[entriesIndex]["destination"] = document.getElementById("destination").value;
            entries[entriesIndex]["purpose"] = document.getElementById("purpose").value;
            clearEntryForm();
            populateTable();
            tableMain.style.display = "flex";
            entryMain.style.display = "none";
            console.log(entries);
        }

        function cancelEdit() {
            clearEntryForm();
            populateTable()
            tableMain.style.display = "flex";
            entryMain.style.display = "none";
            console.log(entries);
        }

        function deleteEntry() {
            if (confirm("Really delete?")) {
                let tableRowIndex = parseInt(document.getElementById("table-row-index").innerText);
                let entriesIndex = tableRowIndex - 1;
                entries.splice(entriesIndex, 1);
                clearEntryForm();
                clearEntryForm();
                populateTable();
                tableMain.style.display = "flex";
                entryMain.style.display = "none";
                console.log(entries);
            }
        }

        function clearEntryForm() {
            document.getElementById("table-row-index").innerText = "-1";
            document.getElementById("entry-date").value = getTodaysDate();
            document.getElementById("start").value = 0;
            document.getElementById("end").value = 0;
            document.getElementById("destination").value = "";
            document.getElementById("purpose").value = "";
            console.log(entries);
        }

        function populateTable() {
            let startDate = document.getElementById("start-date").value;
            let endDate = document.getElementById("end-date").value;
            let totalMileage = 0;
            let tableString = "<tr><th></th><th>Date</th><th>Start</th><th>End</th><th>Distance</th><th>Dest</th><th>Purpose</th></tr>";
            for (let i = 0; i < entries.length; i++) {
                // let index = entries[i]["index"];
                let date = entries[i]["date"];
                if ((date >= startDate) && (date <= endDate)) {
                    let start = entries[i]["start"];
                    let end = entries[i]["end"];
                    let distance = end - start;
                    totalMileage += distance;
                    let destination = entries[i]["destination"];
                    let purpose = entries[i]["purpose"];
                    tableString += `<tr onclick='editEntry(${i})'><th>${i+1}</th><td>${date}</td><td>${start}</td><td>${end}</td><td>${distance}</td><td>${destination}</td><td>${purpose}</td></tr>`
                }
            }
            tableString += `<tr><th></th><th></th><th></th><th>Total:</th><th>${totalMileage}</th><th></th><th></th><tr>`;
            document.getElementById("mileage-table").innerHTML = tableString;

        }

        function load() {
            let fileContents = "";
            let inputTypeIsFile = document.createElement('input');
            inputTypeIsFile.type = "file";
            inputTypeIsFile.addEventListener("change", function() {
                let inputFile = inputTypeIsFile.files[0];
                let fileReader = new FileReader();
                fileReader.onload = function(fileLoadedEvent) {
                    fileContents = fileLoadedEvent.target.result;
                    entries = JSON.parse(fileContents);
                    populateTable();
                };
                fileReader.readAsText(inputFile, "UTF-8");
            });
            inputTypeIsFile.click();
        }

        function save() {
            basename = "mileageTracker" + getTodaysDate();
            saveStringToTextFile(JSON.stringify(entries), basename, ".json");
        }

        function saveStringToTextFile(str1, basename = "myfile", fileType = ".txt") {
            let filename = basename + fileType;
            let blobVersionOfText = new Blob([str1], {
                type: "text/plain"
            });
            let urlToBlob = window.URL.createObjectURL(blobVersionOfText);
            let downloadLink = document.createElement("a");
            downloadLink.style.display = "none";
            downloadLink.download = filename;
            downloadLink.href = urlToBlob;
            document.body.appendChild(downloadLink);
            downloadLink.click();
            downloadLink.parentElement.removeChild(downloadLink);
        }

        //Date related functions for convience, uses same format as input type="date"
        function getTodaysDate() {
            let now = new Date();
            let day = ("0" + now.getDate()).slice(-2);
            let month = ("0" + (now.getMonth() + 1)).slice(-2);
            let today = now.getFullYear() + "-" + month + "-" + day;
            return today;
        }

        function getFirstDayOfThisMonthDate() {
            let now = new Date();
            let day = "01";
            let month = ("0" + (now.getMonth() + 1)).slice(-2);
            return now.getFullYear() + "-" + month + "-" + day;
        }

        function getLastDayOfThisMonthDate() {
            let now = new Date();
            let day = daysInThisMonth().toString();
            day = "0" + day;
            day = day.slice(-2);
            let month = ("0" + (now.getMonth() + 1)).slice(-2);
            return now.getFullYear() + "-" + month + "-" + day;
        }

        function daysInSomeMonth(someMonth, someYear) { //use jan month is 0
            return new Date(someYear, someMonth + 1, 0).getDate();
        }

        function daysInThisMonth() {
            thisDate = new Date();
            thisMonth = thisDate.getMonth();
            thisYear = thisDate.getYear();
            return daysInSomeMonth(thisMonth, thisYear);
        }

        ////Asks if you really want to close browser

        window.onbeforeunload = askConfirm;
        let needsSave = true;

        function askConfirm() {
            if (needsSave === true) {
                return "Did you remember to save your data?";
            } else {
                return;
            }
        }

        entryMain.style.display = "none";
        document.getElementById("start-date").value = getFirstDayOfThisMonthDate();
        document.getElementById("end-date").value = getLastDayOfThisMonthDate();
        document.getElementById("entry-date").value = getTodaysDate();
    </script>
</body>

</html>